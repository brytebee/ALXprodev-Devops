#!/bin/bash

csv_file="pokemon_report.csv"

# Create CSV with header
echo "Name,Height (m),Weight (kg)" > "$csv_file"

# Process all JSON files and extract data
for json_file in pokemon_data/*.json; do
    if [ -f "$json_file" ]; then
        # Extract data using jq and process with sed for additional formatting
        jq -r '"\(.name | ascii_upcase[:1] + ascii_downcase[1:]),\(.height/10),\(.weight/10)"' "$json_file" | \
        sed 's/\([^,]*\),\([^,]*\),\(.*\)/\1,\2,\3/' >> "$csv_file"
    fi
done

echo "CSV Report generated at: $csv_file"
echo ""

# Display CSV with sed formatting for better readability
echo "=== Pokemon Data Report ==="
sed '1s/.*/& (Header)/' "$csv_file" | \
sed '2,$s/^/Pokemon: /' | \
sed 's/,/ | Height: /2' | \
sed 's/,/ m | Weight: /2' | \
sed 's/$/ kg/' | \
sed '1s/ (Header).*//'

echo ""
echo "=== Raw CSV Data ==="
cat "$csv_file"
echo ""

# Use sed to clean up any potential formatting issues before awk processing
temp_file=$(mktemp)
sed 's/[[:space:]]*$//' "$csv_file" > "$temp_file"

# Calculate averages using awk on the cleaned CSV (skip header)
echo "=== Statistical Analysis ==="
awk -F',' 'NR>1 {
    height+=$2; 
    weight+=$3; 
    count++
    if(NR==2) {min_height=max_height=$2; min_weight=max_weight=$3}
    if($2<min_height) min_height=$2
    if($2>max_height) max_height=$2
    if($3<min_weight) min_weight=$3
    if($3>max_weight) max_weight=$3
} 
END {
    if(count>0) {
        printf "Count: %d Pokemon\n", count
        printf "Average Height: %.2f m\n", height/count
        printf "Average Weight: %.2f kg\n", weight/count
        printf "Height Range: %.2f - %.2f m\n", min_height, max_height
        printf "Weight Range: %.2f - %.2f kg\n", min_weight, max_weight
    } else {
        print "No data found"
    }
}' "$temp_file"

# Clean up temporary file
rm "$temp_file"

# Use sed to create a summary file with formatted output
summary_file="pokemon_summary.txt"
echo "=== Pokemon Report Summary ===" > "$summary_file"
echo "Generated on: $(date)" >> "$summary_file"
echo "" >> "$summary_file"

# Extract just the pokemon names using sed
echo "Pokemon Names:" >> "$summary_file"
sed -n '2,$p' "$csv_file" | sed 's/,.*$//' | sed 's/^/- /' >> "$summary_file"

echo ""
echo "Summary file created: $summary_file"